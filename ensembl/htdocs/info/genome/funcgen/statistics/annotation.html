<!DOCTYPE html>
<html>

<head>
    <meta name="order" content="3" />
    <meta name="navigation" content="Annotation statistics">
    <meta charset="UTF-8">
    <title>Annotation statistics</title>
</head>

<body>
    <script src="js/Chart.bundle.js"></script>
    <script src="js/RegulationChartUtils.js"></script>
    <link rel="stylesheet" type="text/css" href="DataTables.css">

    <h1>Regulatory build</h1>

    <p>
        Name: Ensembl Regulatory Build
    </p>

    <p>
        Description: The Ensembl Regulatory Build updated for Human GRCh38 release 109
    </p>

    <h2>Summary statistics</h2>

    <p>
        The regulatory build has a total of
        548,310
        regulatory features from
        118
        epigenomes (previously
        118).
    </p>

    <h3>Overview</h3>

    <script type="text/javascript" class="init">
        $(document).ready(function () {
            $('#overview').DataTable();
        });
    </script>

    <table id="overview" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>Type</th>
                <th>Previous</th>
                <th>Current</th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td>Number of epigenomes</td>
                <td align="right">118</td>
                <td align="right">118</td>
            </tr>
            <tr>
                <td>Number of regulatory features</td>
                <td align="right">622,461</td>
                <td align="right">548,310</td>
            </tr>
            <tr>
                <td>Genome covered</td>
                <td align="right">19.72%</td>
                <td align="right">19.11%</td>
            </tr>
        </tbody>
    </table>

    <script>
        var color = Chart.helpers.color;

        var barChartData_comparison_number_of_epigenomes = {
            labels: [
                "Number of epigenomes",
            ],
            datasets: [{
                    label: 'Previous',
                    //label: 'Release 87',
                    backgroundColor: window.chartColors.blue,
                    data: [
                        118,
                    ]
                },
                {
                    label: 'Current',
                    //label: 'Release 95',
                    backgroundColor: window.chartColors.red,
                    data: [
                        118,
                    ]
                },
            ]
        };
    </script>

    <script>
        var color = Chart.helpers.color;

        var barChartData_comparison_with_previous_version_total_numbers = {
            labels: [
                "Number of regulatory features",
            ],
            datasets: [{
                    label: 'Previous',
                    //label: 'Release 87',
                    backgroundColor: window.chartColors.blue,
                    data: [
                        622461,
                    ]
                },
                {
                    label: 'Current',
                    //label: 'Release 95',
                    backgroundColor: window.chartColors.red,
                    data: [
                        548310,
                    ]
                },
            ]
        };
    </script>

    </br>

    <h3>Genome coverage</h3>

    <p>
        The regulatory features cover
        19.11%
        of the genome. If overlaps were not taken into account, this would be:
        20.37% of the genome.
    </p>

    <p>
        Warning: This pie chart does not take overlaps into account. If the genome coverage when taking overlaps into
        account is significantly different from the one that doesn't, then this pie chart will overstate the percentage
        of the genome covered in regulatory features. When there are significant amounts of overlap, it is better to use
        the &quot;<a href="#percent_of_genome_covered_by_feature_type">Percent of genome covered by feature
            type</a>&quot; chart below.
    </p>

    <div id="canvas-holder" style="width:50%;">
        <canvas id="chart-area-genome-coverage-regulatory-build-current" />
    </div>

    <script>
        var genome_coverage_regulatory_build_current_config = {
            type: 'pie',
            data: {
                datasets: [{
                    data: [

                        2.11,
                        10.79,
                        5.60,
                        0.48,
                        1.35,
                        79.67

                    ],
                    backgroundColor: [
                        '#40e0d0',
                        '#faca02',
                        '#ff0200',
                        '#cd96cd',
                        '#d9d9d9',
                        '#7f7f7f',
                    ],

                }],
                labels: [
                    "CTCF Binding Site",
                    "Enhancer",
                    "Promoter",
                    "TF binding",
                    "Open chromatin",
                    "Not covered by regulatory build",
                ]
            },
            options: {
                responsive: true,
                legend: {
                    position: 'left'
                },
                title: {
                    display: 'false',
                    text: 'Genome coverage of the Regulatory Build in homo_sapiens'
                },
                tooltips: {
                    callbacks: {
                        title: function (item, data) {
                            // Pick first xLabel for now
                            var title = '';

                            if (item.length > 0) {
                                if (item[0].yLabel) {
                                    title = item[0].yLabel;
                                } else if (data.labels.length > 0 && item[0].index < data.labels.length) {
                                    title = data.labels[item[0].index];
                                }
                            }

                            return title;
                        },

                        label: function (item, data) {
                            //var datasetLabel = data.datasets[item.datasetIndex].label || 'No label found';
                            var datasetLabel = data.labels[item.index] || 'No label found';
                            return datasetLabel + ': ' + data.datasets[item.datasetIndex].data[item.index] +
                                '% of genome';
                        }
                    },
                    mode: 'index',
                    axis: 'y'
                }
            }
        };
    </script>

    <h3>Summary</h3>

    <table id="regulatory_build_1" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>Type</th>
                <th>Total length in bp</th>
                <th>Number of features</th>
                <th>Average length</th>
            </tr>
        </thead>
        
        <tbody>
        <tr>
            <td>CTCF</td>
            <td align="right">65,245,400</td>
            <td align="right">101,734</td>
            <td align="right">641.33</td>
        </tr>
        <tr>
            <td>Enhancer</td>
            <td align="right">334,159,000</td>
            <td align="right">268,483</td>
            <td align="right">1,244.62</td>
        </tr>
        <tr>
            <td>Promoter</td>
            <td align="right">173,514,109</td>
            <td align="right">36,597</td>
            <td align="right">4,741.20</td>
        </tr>
        <tr>
            <td>Transcription Factor binding</td>
            <td align="right">15,834,600</td>
            <td align="right">30,873</td>
            <td align="right">512.9</td>
        </tr>
        <tr>
            <td>Open Chromatin</td>
            <td align="right">41,883,200</td>
            <td align="right">110,623</td>
            <td align="right">378.61</td>
        </tr>
        </tbody>
        </table>

    <script src="https://d3js.org/d3.v4.min.js"></script>

    <!-- From https://github.com/benfred/venn.js/ -->
    <script type="text/javascript" src="js/venn.js"></script>

    <style>
        .venntooltip {
            position: absolute;
            text-align: center;
            width: 256px;
            height: 16px;
            background: #333;
            color: #ddd;
            padding: 2px;
            border: 0px;
            border-radius: 8px;
            opacity: 0;
        }
    </style>


    <script>
        var sets = [{
                "sets": [0],
                "label": "Previous Regulatory Build (622,461 features)",
                "size": 622461
            },
            {
                "sets": [1],
                "label": "Current Regulatory Build (622,461 features)",
                "size": 622461
            },
            {
                "sets": [0, 1],
                "label": "Mapped (491,638 features)",
                "size": 491638
            },
        ];

        var chart = venn.VennDiagram().width(1000).height(500);

        var div = d3.select("#venn")
        div.datum(sets).call(chart);

        var tooltip = d3.select("body").append("div")
            .attr("class", "venntooltip");

        div.selectAll("path")
            .style("stroke-opacity", 0)
            .style("stroke", "#fff")
            .style("stroke-width", 3)

        div.selectAll("g")
            .on("mouseover", function (d, i) {
                // sort all the areas relative to the current item
                venn.sortAreas(div, d);

                // Display a tooltip with the current size
                tooltip.transition().duration(400).style("opacity", .9);
                tooltip.text(d.size + " regulatory features");

                // highlight the current path
                var selection = d3.select(this).transition("tooltip").duration(400);
                selection.select("path")
                    .style("fill-opacity", d.sets.length == 1 ? .4 : .1)
                    .style("stroke-opacity", 1);
            })

            .on("mousemove", function () {
                tooltip.style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })

            .on("mouseout", function (d, i) {
                tooltip.transition().duration(400).style("opacity", 0);
                var selection = d3.select(this).transition("tooltip").duration(400);
                selection.select("path")
                    .style("fill-opacity", d.sets.length == 1 ? .25 : .0)
                    .style("stroke-opacity", 0);
            });
    </script>

    <h2>Validation with known Enhancers</h2>

    <h3><a name="vista">VISTA</a></h3>

    <p>
        Of the 991 VISTA enhancers in homo sapiens, 685 VISTA enhancers (69.12%) overlap with Ensembl regulatory
        features, excluding CTCF.
    </p>

    <div style="width:50%">
        <canvas id="chart-area-vista-enhancers" />
    </div>

    <script>
        var VISTA_enhancer_validation_regulatory_build_config = {
            type: 'pie',
            data: {
                datasets: [{
                    data: [

                        69.12,
                        30.88,

                    ],
                    backgroundColor: [
                        window.chartColors.green,
                        window.chartColors.gray,
                    ],

                }],
                labels: [
                    "VISTA enhancers found in regulatory build",
                    "VISTA enhancers not found in regulatory build",
                ]
            },
            options: {
                responsive: true,
                legend: {
                    position: 'left'
                },
                title: {
                    display: 'false',
                    text: ''
                },
                tooltips: {
                    callbacks: {
                        title: function (item, data) {
                            // Pick first xLabel for now
                            var title = '';

                            if (item.length > 0) {
                                if (item[0].yLabel) {
                                    title = item[0].yLabel;
                                } else if (data.labels.length > 0 && item[0].index < data.labels.length) {
                                    title = data.labels[item[0].index];
                                }
                            }

                            return title;
                        },

                        label: function (item, data) {
                            var datasetLabel = data.labels[item.index] || 'No label found';
                            return datasetLabel + ': ' + data.datasets[item.datasetIndex].data[item.index] +
                                '% of VISTA enhancers';
                        }
                    },
                    mode: 'index',
                    axis: 'y'
                }
            }
        };
    </script>

    <h3><a name="fantom5">Fantom5</a></h3>

    <p>
        Of the 38,474 robust Fantom5 enhancers in homo sapiens, 18,926 Fantom5 enhancers (49.19%) overlap with Ensembl
        regulatory features, excluding CTCF.
    </p>

    <div style="width:50%">
        <canvas id="chart-area-fantom-enhancers" />
    </div>

    <script>
        var fantom_enhancer_validation_regulatory_build_config = {
            type: 'pie',
            data: {
                datasets: [{
                    data: [

                        49.19,
                        50.81,

                    ],
                    backgroundColor: [
                        window.chartColors.green,
                        window.chartColors.gray,
                    ],

                }],
                labels: [
                    "Fantom5 enhancers found in regulatory build",
                    "Fantom5 enhancers not found in regulatory build",
                ]
            },
            options: {
                responsive: true,
                legend: {
                    position: 'left'
                },
                title: {
                    display: 'false',
                    text: ''
                },
                tooltips: {
                    callbacks: {
                        title: function (item, data) {
                            // Pick first xLabel for now
                            var title = '';

                            if (item.length > 0) {
                                if (item[0].yLabel) {
                                    title = item[0].yLabel;
                                } else if (data.labels.length > 0 && item[0].index < data.labels.length) {
                                    title = data.labels[item[0].index];
                                }
                            }

                            return title;
                        },

                        label: function (item, data) {
                            var datasetLabel = data.labels[item.index] || 'No label found';
                            return datasetLabel + ': ' + data.datasets[item.datasetIndex].data[item.index] +
                                '% of Fantom5 enhancers';
                        }
                    },
                    mode: 'index',
                    axis: 'y'
                }
            }
        };
    </script>

    <h2><a name="comparisons_to_the_previous_regulatory_build">Comparisons to the previous Regulatory Build</a></h2>

    <h3>Percentage of regulatory feature numbers</h3>

    <div style="width: 80%;">
        <canvas id="regulatory_build_2_compared"></canvas>
    </div>

    <script>
        var color = Chart.helpers.color;

        var barChartData_comparison_with_previous_version = {
            labels: [
                "CTCF Binding Site",
                "Enhancer",
                "Promoter",
                "TF binding",
                "Open chromatin",
            ],
            datasets: [{
                    label: 'Previous Regulatory Build',
                    backgroundColor: window.chartColors.blue,
                    data: [
                        '28.16',
                        '43.82',
                        '5.18',
                        '4.96',
                        '17.77',
                    ]
                },
                {
                    label: 'Current Regulatory Build',
                    backgroundColor: window.chartColors.red,
                    data: [
                        '18.30',
                        '48.53',
                        '6.67',
                        '5.63',
                        '20.17',
                    ]
                },
            ]
        };
    </script>

    <h3><a name="percent_of_genome_covered_by_feature_type">Percent of genome covered by feature type</a></h3>

    <div style="width: 80%;">
        <canvas id="regulatory_build_2_compared_lengths_percent_coverage"></canvas>
    </div>

    <script>
        var color = Chart.helpers.color;

        var barChartData_comparison_with_previous_version_lengths_percent_coverage = {
            labels: [
                "Regulatory Build",
                "CTCF Binding Site",
                "Enhancer",
                "Promoter",
                "TF binding",
                "Open chromatin",
            ],
            datasets: [{
                    label: 'Previous Regulatory Build',
                    backgroundColor: window.chartColors.blue,
                    data: [
                        '19.7179',
                        '2.84731',
                        '10.7945',
                        '5.61846',
                        '0.47736',
                        '1.34964',
                    ]
                },
                {
                    label: 'Current Regulatory Build',
                    backgroundColor: window.chartColors.red,
                    data: [
                        '19.1110',
                        '2.1126',
                        '10.7945',
                        '5.61846',
                        '0.47736',
                        '1.34964',
                    ]
                },
            ]
        };
    </script>

    <p>
        All the numbers in this chart take overlaps into account. That means, if regulatory features overlap, the bases
        will be counted only once.
    </p>


    <h3><a name="quantiles">Quantiles of lengths of regulatory features by feature type</a></h3>

    <div style="width: 80%;">
        <canvas id="boxplot_1"></canvas>
    </div>

    <p>
        The bottom whisker is the length of the shortest regulatory feature of that type, the box begins at the end of
        the first quantile and ends at the end of the third quantile. The line in the box is the median. The top whisker
        is the maximum length of a regulatory feature of that type.
    </p>

    <script src="js/ChartBoxPlot/utils.js"></script>
    <script src="js/ChartBoxPlot/Chart.BoxPlot.js" type="text/javascript"></script>

    <script>
        var color = Chart.helpers.color;

        var boxplot_data = {
            labels: [
                "CTCF Binding Site",
                "Enhancer",
                "Promoter",
                "TF binding",
                "Open chromatin",
            ],
            datasets: [{
                    label: 'Previous Regulatory Build',
                    borderWidth: 2,
                    backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
                    borderColor: window.chartColors.blue,
                    data: [{
                            min: 200,
                            whiskerMin: 200,
                            q1: 200,
                            median: 400,
                            q3: 600,
                            max: 14400,
                            whiskerMax: 14400,
                        },
                        {
                            min: 200,
                            whiskerMin: 200,
                            q1: 400,
                            median: 800,
                            q3: 1598,
                            max: 44000,
                            whiskerMax: 44000,
                        },
                        {
                            min: 200,
                            whiskerMin: 200,
                            q1: 2097,
                            median: 3798,
                            q3: 6198,
                            max: 73398,
                            whiskerMax: 73398,
                        },
                        {
                            min: 123,
                            whiskerMin: 123,
                            q1: 338,
                            median: 443,
                            q3: 577,
                            max: 17824,
                            whiskerMax: 17824,
                        },
                        {
                            min: 48,
                            whiskerMin: 48,
                            q1: 257,
                            median: 333,
                            q3: 450,
                            max: 4491,
                            whiskerMax: 4491,
                        },
                    ]
                },
                {
                    label: 'Current Regulatory Build',
                    borderWidth: 2,
                    backgroundColor: color(window.chartColors.red).alpha(0.5).rgbString(),
                    borderColor: window.chartColors.red,
                    data: [{
                            min: 200,
                            whiskerMin: 200,
                            q1: 200,
                            median: 400,
                            q3: 800,
                            max: 14400,
                            whiskerMax: 14400,
                        },
                        {
                            min: 200,
                            whiskerMin: 200,
                            q1: 400,
                            median: 800,
                            q3: 1598,
                            max: 44000,
                            whiskerMax: 44000,
                        },
                        {
                            min: 200,
                            whiskerMin: 200,
                            q1: 2097,
                            median: 3798,
                            q3: 6198,
                            max: 73398,
                            whiskerMax: 73398,
                        },
                        {
                            min: 123,
                            whiskerMin: 123,
                            q1: 338,
                            median: 443,
                            q3: 577,
                            max: 17824,
                            whiskerMax: 17824,
                        },
                        {
                            min: 48,
                            whiskerMin: 48,
                            q1: 257,
                            median: 333,
                            q3: 450,
                            max: 4491,
                            whiskerMax: 4491,
                        },
                    ]
                }
            ]
        };
    </script>

    <h3><a name="total_lengths_in_base_pairs">Total lengths in base pairs</a></h3>

    <div style="width: 80%;">
        <canvas id="regulatory_build_2_compared_lengths"></canvas>
    </div>

    <p>
        Things to look at:
    </p>

    <ul>
        <li>
            How does the current version compare to the previous,
        </li>
        <li>
            Genome covered vs sum of feature lengths is an indicator for the degree of overlap there is between features
            of the same type.
        </li>
    </ul>

    <script>
        var color = Chart.helpers.color;

        var barChartData_comparison_with_previous_version_lengths = {
            labels: [
                "CTCF Binding Site",
                "Enhancer",
                "Promoter",
                "TF binding",
                "Open chromatin",
            ],
            datasets: [{
                    label: 'previous sum feature lengths',
                    backgroundColor: window.chartColors.blue,
                    data: [
                        '87933000',
                        '334158907',
                        '173514109',
                        '15834599',
                        '41883203'
                    ]
                },
                {
                    label: 'new sum feature lengths',
                    backgroundColor: window.chartColors.red,
                    data: [
                        '65245400',
                        '334158907',
                        '173514109',
                        '15834599',
                        '41883203'
                    ]
                },
            ]
        };
    </script>

    <h3><a name="average_lengths_of_regulatory_features">Average lengths of regulatory features</h3>

    <div style="width: 80%;">
        <canvas id="regulatory_build_2_compared_average_lengths"></canvas>
    </div>

    <script>
        var color = Chart.helpers.color;

        var barChartData_comparison_with_previous_version_average_lengths = {
            labels: [
                "CTCF Binding Site",
                "Enhancer",
                "Promoter",
                "TF binding",
                "Open chromatin",
            ],
            datasets: [{
                    label: 'Previous Regulatory Build',
                    backgroundColor: window.chartColors.blue,
                    data: [
                        '499.946',
                        '1244.619',
                        '4741.211',
                        '512.895',
                        '378.61',
                    ]
                },
                {
                    label: 'Current Regulatory Build',
                    backgroundColor: window.chartColors.red,
                    data: [
                        '641.33',
                        '1244.619',
                        '4741.211',
                        '512.895',
                        '378.61',
                    ]
                },
            ]
        };
    </script>


    <script>
        window.onload = function () {

            $('#regulatory_build_1').dataTable({
                "iDisplayLength": 10,
                "sPaginationType": "full_numbers"
            });

            ctx = document.getElementById("chart-area-vista-enhancers").getContext("2d");
            new Chart(ctx, VISTA_enhancer_validation_regulatory_build_config);

            ctx = document.getElementById("chart-area-fantom-enhancers").getContext("2d");
            new Chart(ctx, fantom_enhancer_validation_regulatory_build_config);

            ctx2 = document.getElementById("chart-area-genome-coverage-regulatory-build-current").getContext("2d");
            window.myPie = new Chart(ctx2, genome_coverage_regulatory_build_current_config);



            var ctx = document.getElementById('regulatory_build_2_compared').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: barChartData_comparison_with_previous_version,
                options: {
                    responsive: true,
                    legend: {
                        display: true,
                        position: 'bottom',
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0
                            }
                        }]
                    },
                    title: {
                        display: false,
                        text: 'Total numbers by feature type'
                    }
                }
            });

            var ctx = document.getElementById('regulatory_build_2_compared_lengths').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: barChartData_comparison_with_previous_version_lengths,
                options: {
                    responsive: true,
                    legend: {
                        display: true,
                        position: 'bottom',
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0
                            }
                        }]
                    },
                    title: {
                        display: false,
                        text: 'Total numbers by feature type'
                    }
                }
            });

            var ctx = document.getElementById('regulatory_build_2_compared_lengths_percent_coverage').getContext(
                '2d');
            new Chart(ctx, {
                type: 'bar',
                data: barChartData_comparison_with_previous_version_lengths_percent_coverage,
                options: {
                    responsive: true,
                    legend: {
                        display: true,
                        position: 'bottom',
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0
                            }
                        }]
                    },
                    title: {
                        display: false,
                        text: 'Total numbers by feature type'
                    }
                }
            });



            var ctx = document.getElementById('regulatory_build_2_compared_average_lengths').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: barChartData_comparison_with_previous_version_average_lengths,
                options: {
                    responsive: true,
                    legend: {
                        display: true,
                        position: 'bottom',
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0
                            }
                        }]
                    },
                    title: {
                        display: false,
                        text: 'Total numbers by feature type'
                    }
                }
            });



            var bp = document.getElementById('boxplot_1').getContext('2d');
            new Chart(bp, {
                type: 'boxplot',
                data: boxplot_data,
                options: {
                    responsive: true,
                    legend: {
                        display: true,
                        position: 'bottom',
                    },
                    scales: {
                        xAxes: [{
                            // Specific to Bar Controller
                            categoryPercentage: 0.9,
                            barPercentage: 0.8
                        }],
                        yAxes: [{
                            display: true,
                            type: 'arrayLogarithmic',
                            ticks: {
                                suggestedMin: 50,
                                suggestedMax: 100
                            },
                        }, ]
                    },
                    title: {
                        display: false,
                    }
                }
            });




        };
    </script>



</body>

</html>
